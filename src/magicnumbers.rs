#![allow(
    clippy::unreadable_literal,
    clippy::cast_sign_loss,
    clippy::cast_possible_wrap
)]

use std::collections::HashMap;

use crate::{
    bitmethods::{into_bb, Bithackable},
    squares::{Square, SquareTrait},
};

pub fn sliding_attacks(square: Square, occupied: u64, deltas: &[isize]) -> u64 {
    let mut attacks = BB_EMPTY;

    for &delta in deltas {
        let mut sq = square as isize;

        loop {
            sq += delta;
            let from = sq as usize;
            let to = (sq - delta) as usize;
            if !(0..64).contains(&sq) || Square::square_distance(from, to) > 2 {
                break;
            }

            attacks |= into_bb(from);

            if (occupied & into_bb(from)).any_set() {
                break;
            }
        }
    }

    attacks
}

pub fn edges(square: Square) -> u64 {
    ((BB_RANK_1 | BB_RANK_8) & !BB_RANKS[square.rank()])
        | ((BB_FILE_A | BB_FILE_H) & !BB_FILES[square.file()])
}

struct CarryRippler {
    mask: i64,
    subset: i64,
    first: bool,
}

const fn carry_rippler(mask: u64) -> CarryRippler {
    CarryRippler { mask: mask as i64, subset: 0, first: true }
}

impl Iterator for CarryRippler {
    type Item = u64;

    fn next(&mut self) -> Option<u64> {
        if self.subset != 0 || self.first {
            let out = self.subset;
            self.subset = (self.subset - self.mask) & self.mask;
            self.first = false;
            Some(out as u64)
        } else {
            None
        }
    }
}

fn gen_attack_tables(deltas: &[isize]) -> Vec<HashMap<u64, u64>> {
    let mut attack_table = Vec::new();

    for square in 0..64 {
        let mut attacks = HashMap::new();

        let mask = sliding_attacks(square, 0, deltas) & !edges(square);
        for subset in carry_rippler(mask) {
            let insert_v = sliding_attacks(square, subset, deltas);
            attacks.insert(subset, insert_v);
        }

        attack_table.push(attacks);
    }

    attack_table
}

lazy_static! {
    pub static ref BB_RAYS: [[u64; 64]; 64] = {
        let mut rays = [[0; 64]; 64];
        for (a, bb_a) in (0..64).map(|i| (i, 1 << i)) {
            for (b, bb_b) in (0..64).map(|i| (i, 1 << i)) {
                if (BB_DIAG_ATTACKS[a][&0] & bb_b).any_set() {
                    rays[a][b] = (BB_DIAG_ATTACKS[a][&0] & BB_DIAG_ATTACKS[b][&0]) | bb_a | bb_b;
                } else if (BB_RANK_ATTACKS[a][&0] & bb_b).any_set() {
                    rays[a][b] = BB_RANK_ATTACKS[a][&0] | bb_a;
                } else if (BB_FILE_ATTACKS[a][&0] & bb_b).any_set() {
                    rays[a][b] = BB_FILE_ATTACKS[a][&0] | bb_a;
                } else {
                    rays[a][b] = BB_EMPTY;
                }
            }
        }
        rays
    };
    pub static ref BB_DIAG_ATTACKS: Vec<HashMap<u64, u64>> = gen_attack_tables(&[-9, -7, 7, 9]);
    pub static ref BB_FILE_ATTACKS: Vec<HashMap<u64, u64>> = gen_attack_tables(&[-8, 8]);
    pub static ref BB_RANK_ATTACKS: Vec<HashMap<u64, u64>> = gen_attack_tables(&[-1, 1]);
}

pub const BB_A1: u64 = 1_u64 << 0;
pub const BB_B1: u64 = 1_u64 << 1;
pub const BB_C1: u64 = 1_u64 << 2;
pub const BB_D1: u64 = 1_u64 << 3;
pub const BB_E1: u64 = 1_u64 << 4;
pub const BB_F1: u64 = 1_u64 << 5;
pub const BB_G1: u64 = 1_u64 << 6;
pub const BB_H1: u64 = 1_u64 << 7;
pub const BB_A2: u64 = 1_u64 << 8;
pub const BB_B2: u64 = 1_u64 << 9;
pub const BB_C2: u64 = 1_u64 << 10;
pub const BB_D2: u64 = 1_u64 << 11;
pub const BB_E2: u64 = 1_u64 << 12;
pub const BB_F2: u64 = 1_u64 << 13;
pub const BB_G2: u64 = 1_u64 << 14;
pub const BB_H2: u64 = 1_u64 << 15;
pub const BB_A3: u64 = 1_u64 << 16;
pub const BB_B3: u64 = 1_u64 << 17;
pub const BB_C3: u64 = 1_u64 << 18;
pub const BB_D3: u64 = 1_u64 << 19;
pub const BB_E3: u64 = 1_u64 << 20;
pub const BB_F3: u64 = 1_u64 << 21;
pub const BB_G3: u64 = 1_u64 << 22;
pub const BB_H3: u64 = 1_u64 << 23;
pub const BB_A4: u64 = 1_u64 << 24;
pub const BB_B4: u64 = 1_u64 << 25;
pub const BB_C4: u64 = 1_u64 << 26;
pub const BB_D4: u64 = 1_u64 << 27;
pub const BB_E4: u64 = 1_u64 << 28;
pub const BB_F4: u64 = 1_u64 << 29;
pub const BB_G4: u64 = 1_u64 << 30;
pub const BB_H4: u64 = 1_u64 << 31;
pub const BB_A5: u64 = 1_u64 << 32;
pub const BB_B5: u64 = 1_u64 << 33;
pub const BB_C5: u64 = 1_u64 << 34;
pub const BB_D5: u64 = 1_u64 << 35;
pub const BB_E5: u64 = 1_u64 << 36;
pub const BB_F5: u64 = 1_u64 << 37;
pub const BB_G5: u64 = 1_u64 << 38;
pub const BB_H5: u64 = 1_u64 << 39;
pub const BB_A6: u64 = 1_u64 << 40;
pub const BB_B6: u64 = 1_u64 << 41;
pub const BB_C6: u64 = 1_u64 << 42;
pub const BB_D6: u64 = 1_u64 << 43;
pub const BB_E6: u64 = 1_u64 << 44;
pub const BB_F6: u64 = 1_u64 << 45;
pub const BB_G6: u64 = 1_u64 << 46;
pub const BB_H6: u64 = 1_u64 << 47;
pub const BB_A7: u64 = 1_u64 << 48;
pub const BB_B7: u64 = 1_u64 << 49;
pub const BB_C7: u64 = 1_u64 << 50;
pub const BB_D7: u64 = 1_u64 << 51;
pub const BB_E7: u64 = 1_u64 << 52;
pub const BB_F7: u64 = 1_u64 << 53;
pub const BB_G7: u64 = 1_u64 << 54;
pub const BB_H7: u64 = 1_u64 << 55;
pub const BB_A8: u64 = 1_u64 << 56;
pub const BB_B8: u64 = 1_u64 << 57;
pub const BB_C8: u64 = 1_u64 << 58;
pub const BB_D8: u64 = 1_u64 << 59;
pub const BB_E8: u64 = 1_u64 << 60;
pub const BB_F8: u64 = 1_u64 << 61;
pub const BB_G8: u64 = 1_u64 << 62;
pub const BB_H8: u64 = 1_u64 << 63;

pub const BB_RANK_1: u64 = BB_A1 | BB_B1 | BB_C1 | BB_D1 | BB_E1 | BB_F1 | BB_G1 | BB_H1;
pub const BB_RANK_2: u64 = BB_A2 | BB_B2 | BB_C2 | BB_D2 | BB_E2 | BB_F2 | BB_G2 | BB_H2;
pub const BB_RANK_3: u64 = BB_A3 | BB_B3 | BB_C3 | BB_D3 | BB_E3 | BB_F3 | BB_G3 | BB_H3;
pub const BB_RANK_4: u64 = BB_A4 | BB_B4 | BB_C4 | BB_D4 | BB_E4 | BB_F4 | BB_G4 | BB_H4;
pub const BB_RANK_5: u64 = BB_A5 | BB_B5 | BB_C5 | BB_D5 | BB_E5 | BB_F5 | BB_G5 | BB_H5;
pub const BB_RANK_6: u64 = BB_A6 | BB_B6 | BB_C6 | BB_D6 | BB_E6 | BB_F6 | BB_G6 | BB_H6;
pub const BB_RANK_7: u64 = BB_A7 | BB_B7 | BB_C7 | BB_D7 | BB_E7 | BB_F7 | BB_G7 | BB_H7;
pub const BB_RANK_8: u64 = BB_A8 | BB_B8 | BB_C8 | BB_D8 | BB_E8 | BB_F8 | BB_G8 | BB_H8;

pub const BB_RANKS: [u64; 8] = [
    BB_RANK_1,
    BB_RANK_2,
    BB_RANK_3,
    BB_RANK_4,
    BB_RANK_5,
    BB_RANK_6,
    BB_RANK_7,
    BB_RANK_8,
];

pub const BB_FILE_A: u64 = BB_A1 | BB_A2 | BB_A3 | BB_A4 | BB_A5 | BB_A6 | BB_A7 | BB_A8;
pub const BB_FILE_B: u64 = BB_B1 | BB_B2 | BB_B3 | BB_B4 | BB_B5 | BB_B6 | BB_B7 | BB_B8;
pub const BB_FILE_C: u64 = BB_C1 | BB_C2 | BB_C3 | BB_C4 | BB_C5 | BB_C6 | BB_C7 | BB_C8;
pub const BB_FILE_D: u64 = BB_D1 | BB_D2 | BB_D3 | BB_D4 | BB_D5 | BB_D6 | BB_D7 | BB_D8;
pub const BB_FILE_E: u64 = BB_E1 | BB_E2 | BB_E3 | BB_E4 | BB_E5 | BB_E6 | BB_E7 | BB_E8;
pub const BB_FILE_F: u64 = BB_F1 | BB_F2 | BB_F3 | BB_F4 | BB_F5 | BB_F6 | BB_F7 | BB_F8;
pub const BB_FILE_G: u64 = BB_G1 | BB_G2 | BB_G3 | BB_G4 | BB_G5 | BB_G6 | BB_G7 | BB_G8;
pub const BB_FILE_H: u64 = BB_H1 | BB_H2 | BB_H3 | BB_H4 | BB_H5 | BB_H6 | BB_H7 | BB_H8;

pub const BB_FILES: [u64; 8] = [
    BB_FILE_A,
    BB_FILE_B,
    BB_FILE_C,
    BB_FILE_D,
    BB_FILE_E,
    BB_FILE_F,
    BB_FILE_G,
    BB_FILE_H,
];

pub const BB_BACKRANKS: u64 = BB_RANK_1 | BB_RANK_8;

pub const BB_CORNERS: u64 = BB_A1 | BB_H1 | BB_A8 | BB_H8;
pub const BB_CENTER: u64 = BB_D4 | BB_E4 | BB_D5 | BB_E5;

pub const BB_EMPTY: u64 = 0;
pub const BB_ALL: u64 = 0xffff_ffff_ffff_ffff;
pub const BB_LIGHT_SQUARES: u64 = 0x55aa_55aa_55aa_55aa;
pub const BB_DARK_SQUARES: u64 = 0xaa55_aa55_aa55_aa55;

pub const BB_KNIGHT_ATTACKS: [u64; 64] = [
    132096,
    329728,
    659712,
    1319424,
    2638848,
    5277696,
    10489856,
    4202496,
    33816580,
    84410376,
    168886289,
    337772578,
    675545156,
    1351090312,
    2685403152,
    1075839008,
    8657044482,
    21609056261,
    43234889994,
    86469779988,
    172939559976,
    345879119952,
    687463207072,
    275414786112,
    2216203387392,
    5531918402816,
    11068131838464,
    22136263676928,
    44272527353856,
    88545054707712,
    175990581010432,
    70506185244672,
    567348067172352,
    1416171111120896,
    2833441750646784,
    5666883501293568,
    11333767002587136,
    22667534005174272,
    45053588738670592,
    18049583422636032,
    145241105196122112,
    362539804446949376,
    725361088165576704,
    1450722176331153408,
    2901444352662306816,
    5802888705324613632,
    11533718717099671552,
    4620693356194824192,
    288234782788157440,
    576469569871282176,
    1224997833292120064,
    2449995666584240128,
    4899991333168480256,
    9799982666336960512,
    1152939783987658752,
    2305878468463689728,
    1128098930098176,
    2257297371824128,
    4796069720358912,
    9592139440717824,
    19184278881435648,
    38368557762871296,
    4679521487814656,
    9077567998918656,
];

pub const BB_KING_ATTACKS: [u64; 64] = [
    770,
    1797,
    3594,
    7188,
    14376,
    28752,
    57504,
    49216,
    197123,
    460039,
    920078,
    1840156,
    3680312,
    7360624,
    14721248,
    12599488,
    50463488,
    117769984,
    235539968,
    471079936,
    942159872,
    1884319744,
    3768639488,
    3225468928,
    12918652928,
    30149115904,
    60298231808,
    120596463616,
    241192927232,
    482385854464,
    964771708928,
    825720045568,
    3307175149568,
    7718173671424,
    15436347342848,
    30872694685696,
    61745389371392,
    123490778742784,
    246981557485568,
    211384331665408,
    846636838289408,
    1975852459884544,
    3951704919769088,
    7903409839538176,
    15806819679076352,
    31613639358152704,
    63227278716305408,
    54114388906344448,
    216739030602088448,
    505818229730443264,
    1011636459460886528,
    2023272918921773056,
    4046545837843546112,
    8093091675687092224,
    16186183351374184448,
    13853283560024178688,
    144959613005987840,
    362258295026614272,
    724516590053228544,
    1449033180106457088,
    2898066360212914176,
    5796132720425828352,
    11592265440851656704,
    4665729213955833856,
];

pub const BB_PAWN_ATTACKS: [[u64; 64]; 2] = [
    [
        512,
        1280,
        2560,
        5120,
        10240,
        20480,
        40960,
        16384,
        131072,
        327680,
        655360,
        1310720,
        2621440,
        5242880,
        10485760,
        4194304,
        33554432,
        83886080,
        167772160,
        335544320,
        671088640,
        1342177280,
        2684354560,
        1073741824,
        8589934592,
        21474836480,
        42949672960,
        85899345920,
        171798691840,
        343597383680,
        687194767360,
        274877906944,
        2199023255552,
        5497558138880,
        10995116277760,
        21990232555520,
        43980465111040,
        87960930222080,
        175921860444160,
        70368744177664,
        562949953421312,
        1407374883553280,
        2814749767106560,
        5629499534213120,
        11258999068426240,
        22517998136852480,
        45035996273704960,
        18014398509481984,
        144115188075855872,
        360287970189639680,
        720575940379279360,
        1441151880758558720,
        2882303761517117440,
        5764607523034234880,
        11529215046068469760,
        4611686018427387904,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
    ],
    [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        5,
        10,
        20,
        40,
        80,
        160,
        64,
        512,
        1280,
        2560,
        5120,
        10240,
        20480,
        40960,
        16384,
        131072,
        327680,
        655360,
        1310720,
        2621440,
        5242880,
        10485760,
        4194304,
        33554432,
        83886080,
        167772160,
        335544320,
        671088640,
        1342177280,
        2684354560,
        1073741824,
        8589934592,
        21474836480,
        42949672960,
        85899345920,
        171798691840,
        343597383680,
        687194767360,
        274877906944,
        2199023255552,
        5497558138880,
        10995116277760,
        21990232555520,
        43980465111040,
        87960930222080,
        175921860444160,
        70368744177664,
        562949953421312,
        1407374883553280,
        2814749767106560,
        5629499534213120,
        11258999068426240,
        22517998136852480,
        45035996273704960,
        18014398509481984,
    ],
];

pub const BB_RANK_MASKS: [u64; 64] = [
    126,
    124,
    122,
    118,
    110,
    94,
    62,
    126,
    32256,
    31744,
    31232,
    30208,
    28160,
    24064,
    15872,
    32256,
    8257536,
    8126464,
    7995392,
    7733248,
    7208960,
    6160384,
    4063232,
    8257536,
    2113929216,
    2080374784,
    2046820352,
    1979711488,
    1845493760,
    1577058304,
    1040187392,
    2113929216,
    541165879296,
    532575944704,
    523986010112,
    506806140928,
    472446402560,
    403726925824,
    266287972352,
    541165879296,
    138538465099776,
    136339441844224,
    134140418588672,
    129742372077568,
    120946279055360,
    103354093010944,
    68169720922112,
    138538465099776,
    35465847065542656,
    34902897112121344,
    34339947158700032,
    33214047251857408,
    30962247438172160,
    26458647810801664,
    17451448556060672,
    35465847065542656,
    9079256848778919936,
    8935141660703064064,
    8791026472627208192,
    8502796096475496448,
    7926335344172072960,
    6773413839565225984,
    4467570830351532032,
    9079256848778919936,
];

pub const BB_FILE_MASKS: [u64; 64] = [
    282578800148736,
    565157600297472,
    1130315200594944,
    2260630401189888,
    4521260802379776,
    9042521604759552,
    18085043209519104,
    36170086419038208,
    282578800148480,
    565157600296960,
    1130315200593920,
    2260630401187840,
    4521260802375680,
    9042521604751360,
    18085043209502720,
    36170086419005440,
    282578800083200,
    565157600166400,
    1130315200332800,
    2260630400665600,
    4521260801331200,
    9042521602662400,
    18085043205324800,
    36170086410649600,
    282578783371520,
    565157566743040,
    1130315133486080,
    2260630266972160,
    4521260533944320,
    9042521067888640,
    18085042135777280,
    36170084271554560,
    282574505181440,
    565149010362880,
    1130298020725760,
    2260596041451520,
    4521192082903040,
    9042384165806080,
    18084768331612160,
    36169536663224320,
    281479288520960,
    562958577041920,
    1125917154083840,
    2251834308167680,
    4503668616335360,
    9007337232670720,
    18014674465341440,
    36029348930682880,
    1103823438080,
    2207646876160,
    4415293752320,
    8830587504640,
    17661175009280,
    35322350018560,
    70644700037120,
    141289400074240,
    282578800148736,
    565157600297472,
    1130315200594944,
    2260630401189888,
    4521260802379776,
    9042521604759552,
    18085043209519104,
    36170086419038208,
];

pub const BB_DIAG_MASKS: [u64; 64] = [
    18049651735527936,
    70506452091904,
    275415828992,
    1075975168,
    38021120,
    8657588224,
    2216338399232,
    567382630219776,
    9024825867763712,
    18049651735527424,
    70506452221952,
    275449643008,
    9733406720,
    2216342585344,
    567382630203392,
    1134765260406784,
    4512412933816832,
    9024825867633664,
    18049651768822272,
    70515108615168,
    2491752130560,
    567383701868544,
    1134765256220672,
    2269530512441344,
    2256206450263040,
    4512412900526080,
    9024834391117824,
    18051867805491712,
    637888545440768,
    1135039602493440,
    2269529440784384,
    4539058881568768,
    1128098963916800,
    2256197927833600,
    4514594912477184,
    9592139778506752,
    19184279556981248,
    2339762086609920,
    4538784537380864,
    9077569074761728,
    562958610993152,
    1125917221986304,
    2814792987328512,
    5629586008178688,
    11259172008099840,
    22518341868716544,
    9007336962655232,
    18014673925310464,
    2216338399232,
    4432676798464,
    11064376819712,
    22137335185408,
    44272556441600,
    87995357200384,
    35253226045952,
    70506452091904,
    567382630219776,
    1134765260406784,
    2832480465846272,
    5667157807464448,
    11333774449049600,
    22526811443298304,
    9024825867763712,
    18049651735527936,
];
